<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Auxiliar Pro | PreparaciÃ³n 2026</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'farmacia-green': '#00C853',
              'farmacia-dark': '#0d1b2a',
              'metal-bronze': '#cd7f32',
              'metal-silver': '#9e9e9e',
              'metal-gold': '#ffd700',
            },
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              heading: ['Roboto', 'sans-serif']
            },
            animation: {
                'fade-in': 'fadeIn 0.4s ease-out forwards',
                'slide-up': 'slideUp 0.3s ease-out forwards',
            },
            keyframes: {
                fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                slideUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
            }
          }
        }
      }
    </script>
    
    <!-- Fuentes y Efectos -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Iconos Phosphor -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
      body { -webkit-tap-highlight-color: transparent; }
      /* Ocultar scrollbar pero permitir scroll */
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased min-h-screen flex flex-col items-center justify-center font-sans">

    <!-- APP CONTAINER -->
    <div class="w-full max-w-md bg-white h-screen md:h-[90vh] md:rounded-3xl md:shadow-2xl overflow-hidden flex flex-col relative">

        <!-- LOADING OVERLAY -->
        <div id="loading-overlay" class="absolute inset-0 bg-white z-50 flex flex-col items-center justify-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-farmacia-green mb-4"></div>
            <p class="text-sm text-gray-500 animate-pulse">Cargando AuxiliarPro...</p>
        </div>

        <!-- VISTA 1: LANDING -->
        <div id="view-landing" class="flex-1 flex flex-col animate-fade-in overflow-y-auto relative z-10">
            <header class="w-full py-4 px-6 flex justify-between items-center border-b border-gray-100 sticky top-0 bg-white/95 backdrop-blur-sm z-10">
                <div class="flex items-center gap-2">
                    <div class="bg-farmacia-green text-white p-1.5 rounded-md text-xl"><i class="ph-shield-check"></i></div>
                    <span class="font-heading font-bold text-xl tracking-tight text-gray-900">Auxiliar<span class="text-farmacia-green">Pro</span></span>
                </div>
                <button onclick="checkAuthAndStart()" class="text-gray-500 hover:text-farmacia-green text-sm font-medium transition-colors">Ingresar</button>
            </header>

            <main class="flex-1 flex flex-col items-center text-center px-6 mt-10 pb-10">
                <div class="inline-flex items-center gap-2 bg-green-50 border border-green-200 text-green-800 text-xs font-bold px-3 py-1 rounded-full mb-6 uppercase tracking-wide">
                    <span class="w-2 h-2 rounded-full bg-farmacia-green animate-pulse"></span> PreparaciÃ³n 2026
                </div>

                <h1 class="font-heading text-4xl font-extrabold text-gray-900 leading-tight mb-6">
                    PrepÃ¡rate para tu examen de <br />
                    <span class="text-farmacia-green">Auxiliar de Farmacia</span>
                </h1>
                
                <p class="text-gray-500 text-lg mb-8 leading-relaxed max-w-xs mx-auto">
                    Plataforma de estudio independiente. RegÃ­strate para guardar tu progreso real.
                </p>

                <div class="w-full space-y-4 mb-12 max-w-sm mx-auto">
                    <button onclick="checkAuthAndStart()" class="w-full bg-farmacia-dark hover:bg-slate-900 text-white font-bold py-4 px-6 rounded-xl flex items-center justify-center transition-all shadow-lg hover:shadow-xl active:scale-95 group">
                        Comenzar Ahora <i class="ph-caret-right ml-2 group-hover:translate-x-1 transition-transform"></i>
                    </button>
                    
                    <button onclick="switchView('view-blog')" class="w-full bg-white border-2 border-gray-200 text-gray-600 font-bold py-3 px-6 rounded-xl flex items-center justify-center hover:border-farmacia-green hover:text-farmacia-green transition-colors">
                        <i class="ph-book-open mr-2 text-xl"></i> Leer GuÃ­as y ArtÃ­culos
                    </button>
                </div>

                <footer class="text-center border-t border-gray-200 pt-8 pb-4 w-full mt-auto">
                    <p class="text-xs text-gray-400 mb-4">Â© 2025 AuxiliarPro</p>
                    <div class="flex justify-center gap-4 text-[10px] text-gray-500 uppercase font-semibold">
                        <button onclick="toggleModal('legal-modal')">TÃ©rminos</button>
                        <button onclick="toggleModal('legal-modal')">Privacidad</button>
                    </div>
                </footer>
            </main>
        </div>

        <!-- VISTA 2: DASHBOARD -->
        <div id="view-dashboard" class="flex-1 flex flex-col hidden bg-slate-50 animate-fade-in relative z-10 h-full">
            <header class="bg-white shadow-sm py-4 px-6 flex justify-between items-center sticky top-0 z-20">
                <div>
                    <span class="font-heading font-bold text-gray-700 block">Panel de Estudio</span>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-400" id="user-welcome">Hola, Estudiante</span>
                        <span id="offline-badge" class="hidden flex items-center text-[10px] text-amber-600 bg-amber-50 px-1.5 py-0.5 rounded border border-amber-200">
                            <i class="ph-wifi-slash mr-1"></i> Offline
                        </span>
                    </div>
                </div>
                <button onclick="handleLogout()" class="text-gray-400 hover:text-red-500 transition-colors text-2xl"><i class="ph-sign-out"></i></button>
            </header>

            <main class="flex-1 p-6 w-full overflow-y-auto no-scrollbar pb-20">
                <!-- Progress Card -->
                <div class="bg-white rounded-2xl p-6 shadow-md border-t-4 border-farmacia-green mb-8">
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-gray-500 text-xs font-bold uppercase tracking-wider">Tu Progreso</span>
                        <span class="text-farmacia-green font-bold text-xl" id="progress-percent">0%</span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-2.5">
                        <div id="progress-bar" class="bg-farmacia-green h-2.5 rounded-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Levels Container -->
                <div id="levels-container" class="space-y-4">
                    <!-- Los niveles se renderizan con JS -->
                </div>
            </main>
        </div>

        <!-- VISTA 3: BLOG -->
        <div id="view-blog" class="flex-1 flex flex-col hidden bg-white animate-slide-up z-20 h-full absolute inset-0">
            <header class="bg-white shadow-sm py-4 px-6 flex items-center gap-3 sticky top-0 z-10">
                <button onclick="switchView('view-landing')" class="text-2xl text-gray-600"><i class="ph-arrow-left"></i></button>
                <span class="font-bold text-lg">Recursos</span>
            </header>
            <main class="flex-1 p-6 overflow-y-auto" id="blog-container">
                <!-- Posts generados por JS -->
            </main>
        </div>

        <!-- MODAL AUTH -->
        <div id="auth-modal" class="absolute inset-0 z-50 bg-black/60 backdrop-blur-sm hidden items-center justify-center p-4 animate-fade-in">
            <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl p-6 relative">
                <button onclick="toggleModal('auth-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-xl"><i class="ph-x"></i></button>
                
                <div class="text-center mb-6">
                    <div class="bg-green-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 text-farmacia-green text-2xl"><i class="ph-user"></i></div>
                    <h2 class="text-2xl font-bold text-gray-900" id="auth-title">Crear Cuenta</h2>
                    <p class="text-sm text-gray-500 mt-1">Ingresa tus datos para guardar tu progreso.</p>
                </div>

                <form onsubmit="handleAuth(event)" class="space-y-4">
                    <div id="name-field">
                        <div class="relative">
                            <i class="ph-user absolute left-3 top-3.5 text-gray-400 text-lg"></i>
                            <input type="text" id="input-name" placeholder="Tu Nombre" class="w-full pl-10 p-3 rounded-lg border border-gray-300 focus:border-farmacia-green focus:ring-1 focus:ring-farmacia-green outline-none transition-all">
                        </div>
                    </div>
                    <div class="relative">
                        <i class="ph-envelope absolute left-3 top-3.5 text-gray-400 text-lg"></i>
                        <input type="email" id="input-email" placeholder="Correo ElectrÃ³nico" required class="w-full pl-10 p-3 rounded-lg border border-gray-300 focus:border-farmacia-green focus:ring-1 focus:ring-farmacia-green outline-none transition-all">
                    </div>
                    <div class="relative">
                        <i class="ph-key absolute left-3 top-3.5 text-gray-400 text-lg"></i>
                        <input type="password" id="input-pass" placeholder="ContraseÃ±a" required minlength="6" class="w-full pl-10 p-3 rounded-lg border border-gray-300 focus:border-farmacia-green focus:ring-1 focus:ring-farmacia-green outline-none transition-all">
                    </div>

                    <div id="auth-error" class="hidden p-3 bg-red-50 text-red-600 text-xs rounded-lg flex items-center gap-2">
                        <i class="ph-warning-circle"></i> <span id="auth-error-msg">Error</span>
                    </div>

                    <button type="submit" id="btn-auth-submit" class="w-full bg-farmacia-dark hover:bg-slate-900 text-white font-bold py-3 rounded-lg transition-colors">
                        Registrarse
                    </button>

                    <div class="text-center mt-4">
                        <button type="button" onclick="toggleAuthMode()" class="text-sm text-farmacia-green font-medium hover:underline" id="btn-auth-switch">
                            Â¿Ya tienes cuenta? Inicia SesiÃ³n
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- MODAL QUIZ -->
        <div id="quiz-modal" class="absolute inset-0 z-50 bg-white hidden flex-col animate-slide-up">
            <div class="bg-farmacia-dark p-6 text-white flex justify-between items-center shadow-md">
                <div>
                    <h3 class="font-bold text-lg" id="quiz-title">Nivel 1</h3>
                    <p class="text-xs text-gray-400" id="quiz-progress">Pregunta 1 de 3</p>
                </div>
                <button onclick="closeQuiz()" class="text-white/80 hover:text-white text-2xl"><i class="ph-x"></i></button>
            </div>
            <div class="flex-1 p-6 overflow-y-auto" id="quiz-content">
                <!-- Preguntas inyectadas por JS -->
            </div>
        </div>

        <!-- MODAL LEGAL -->
        <div id="legal-modal" class="absolute inset-0 z-50 bg-black/60 backdrop-blur-sm hidden items-center justify-center p-4">
            <div class="bg-white p-6 rounded-xl max-w-sm">
                <h3 class="font-bold mb-2 text-gray-900">InformaciÃ³n Legal</h3>
                <p class="text-sm text-gray-600 mb-4">Esta aplicaciÃ³n es una herramienta de estudio independiente y no tiene afiliaciÃ³n oficial con la entidad certificadora.</p>
                <button onclick="toggleModal('legal-modal')" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg text-sm font-bold text-gray-700 w-full">Cerrar</button>
            </div>
        </div>

    </div>

    <!-- LOGICA JAVASCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

        // --- CONFIGURACIÃ“N (TU API KEY) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDNhuSBBhmmQSV0BHC8MOtLKgAUpvtfWfE",
            authDomain: "auxiliar-pro.firebaseapp.com",
            projectId: "auxiliar-pro",
            storageBucket: "auxiliar-pro.firebasestorage.app",
            messagingSenderId: "342196612566",
            appId: "1:342196612566:web:c7f34365c4e10502e60877"
        };

        // INICIALIZAR
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'auxiliar-pro';

        // --- ESTADO LOCAL ---
        let appState = {
            uid: null,
            name: 'Estudiante',
            email: '',
            currentLevel: 1,
            completedLevels: [],
            isAuthenticated: false
        };

        let currentQuiz = { levelId: 0, qIndex: 0, score: 0, answers: [] };
        let isLoginMode = false;

        // --- DATOS ---
        const LEVELS = [
            { id: 1, title: 'FarmacologÃ­a BÃ¡sica', desc: 'Conceptos y vÃ­as de administraciÃ³n.', passing: 2, qs: [
                { t: 'Â¿VÃ­a que evita paso hepÃ¡tico?', opts: ['VÃ­a Oral', 'VÃ­a Sublingual', 'VÃ­a Rectal', 'VÃ­a TÃ³pica'], c: 1 },
                { t: 'Â¿QuÃ© significa OTC?', opts: ['Receta Retenida', 'Venta Directa', 'AntibiÃ³tico', 'PsicotrÃ³pico'], c: 1 },
                { t: 'Â¿Forma farmacÃ©utica sÃ³lida?', opts: ['Jarabe', 'Comprimido', 'EmulsiÃ³n', 'Colirio'], c: 1 }
            ]},
            { id: 2, title: 'LegislaciÃ³n Sanitaria', desc: 'CÃ³digo Sanitario y reglamentos.', passing: 2, qs: [
                { t: 'Â¿Receta para estupefacientes?', opts: ['Simple', 'Retenida', 'Cheque', 'Magistral'], c: 2 },
                { t: 'Â¿Responsable tÃ©cnico?', opts: ['DueÃ±o', 'Auxiliar', 'QuÃ­mico FarmacÃ©utico', 'Gerente'], c: 2 }
            ]},
            { id: 3, title: 'AtenciÃ³n y DispensaciÃ³n', desc: 'Buenas prÃ¡cticas.', passing: 1, qs: [
                { t: 'Â¿QuÃ© verificar en antibiÃ³ticos?', opts: ['Precio', 'Receta y Vencimiento', 'Marca', 'Caja'], c: 1 }
            ]}
        ];

        const POSTS = [
            { t: 'GuÃ­a de Bioequivalentes', e: 'Diferencia entre genÃ©ricos y bioequivalentes.' },
            { t: 'Cadena de FrÃ­o', e: 'Protocolos para vacunas e insulinas.' },
            { t: 'Decreto Supremo 466', e: 'Reglamento esencial para el examen.' }
        ];

        // --- FUNCIONES UI ---
        
        window.switchView = (viewId) => {
            ['view-landing', 'view-dashboard', 'view-blog'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        };

        window.toggleModal = (modalId) => {
            const el = document.getElementById(modalId);
            if (el.classList.contains('hidden')) {
                el.classList.remove('hidden');
                el.classList.add('flex');
            } else {
                el.classList.add('hidden');
                el.classList.remove('flex');
            }
        };

        // --- LÃ“GICA AUTH ---

        window.checkAuthAndStart = () => {
            if (appState.isAuthenticated) {
                window.switchView('view-dashboard');
            } else {
                // Abrir registro por defecto
                isLoginMode = false;
                updateAuthModalUI();
                window.toggleModal('auth-modal');
            }
        };

        window.toggleAuthMode = () => {
            isLoginMode = !isLoginMode;
            updateAuthModalUI();
        };

        function updateAuthModalUI() {
            const title = document.getElementById('auth-title');
            const nameField = document.getElementById('name-field');
            const btn = document.getElementById('btn-auth-submit');
            const switchBtn = document.getElementById('btn-auth-switch');
            
            if (isLoginMode) {
                title.innerText = 'Iniciar SesiÃ³n';
                nameField.classList.add('hidden');
                document.getElementById('input-name').removeAttribute('required');
                btn.innerText = 'Entrar';
                switchBtn.innerText = 'Â¿No tienes cuenta? RegÃ­strate';
            } else {
                title.innerText = 'Crear Cuenta';
                nameField.classList.remove('hidden');
                document.getElementById('input-name').setAttribute('required', 'true');
                btn.innerText = 'Registrarse';
                switchBtn.innerText = 'Â¿Ya tienes cuenta? Inicia SesiÃ³n';
            }
            document.getElementById('auth-error').classList.add('hidden');
        }

        window.handleAuth = async (e) => {
            e.preventDefault();
            const email = document.getElementById('input-email').value;
            const pass = document.getElementById('input-pass').value;
            const name = document.getElementById('input-name').value;
            const btn = document.getElementById('btn-auth-submit');
            const errorBox = document.getElementById('auth-error');
            const errorMsg = document.getElementById('auth-error-msg');

            btn.disabled = true;
            btn.innerText = 'Procesando...';
            errorBox.classList.add('hidden');

            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, pass);
                } else {
                    const cred = await createUserWithEmailAndPassword(auth, email, pass);
                    await updateProfile(cred.user, { displayName: name });
                    // Crear documento inicial
                    await setDoc(doc(db, 'artifacts', appId, 'users', cred.user.uid, 'data', 'progress'), {
                        name: name, currentLevel: 1, completedLevels: [], lastUpdate: new Date()
                    });
                }
                window.toggleModal('auth-modal');
                window.switchView('view-dashboard');
            } catch (err) {
                console.error(err);
                errorBox.classList.remove('hidden');
                errorMsg.innerText = err.code === 'auth/wrong-password' ? 'ContraseÃ±a incorrecta' : 
                                     err.code === 'auth/user-not-found' ? 'Usuario no encontrado' :
                                     err.code === 'auth/email-already-in-use' ? 'Email ya registrado' :
                                     'Error de conexiÃ³n o datos invÃ¡lidos';
            } finally {
                btn.disabled = false;
                btn.innerText = isLoginMode ? 'Entrar' : 'Registrarse';
            }
        };

        window.handleLogout = async () => {
            await signOut(auth);
            appState = { uid: null, name: 'Estudiante', email: '', currentLevel: 1, completedLevels: [], isAuthenticated: false };
            localStorage.removeItem('auxiliar_pro_data');
            window.switchView('view-landing');
        };

        // --- LÃ“GICA QUIZ ---

        window.startLevel = (id) => {
            currentQuiz = { levelId: id, qIndex: 0, score: 0, answers: [] };
            renderQuiz();
            window.toggleModal('quiz-modal');
            document.getElementById('quiz-modal').classList.remove('hidden');
            document.getElementById('quiz-modal').classList.add('flex');
        };

        window.closeQuiz = () => {
            document.getElementById('quiz-modal').classList.add('hidden');
            document.getElementById('quiz-modal').classList.remove('flex');
        };

        function renderQuiz() {
            const level = LEVELS.find(l => l.id === currentQuiz.levelId);
            const content = document.getElementById('quiz-content');
            document.getElementById('quiz-title').innerText = level.title;
            
            if (currentQuiz.qIndex < level.qs.length) {
                // Pregunta
                const q = level.qs[currentQuiz.qIndex];
                document.getElementById('quiz-progress').innerText = `Pregunta ${currentQuiz.qIndex + 1} de ${level.qs.length}`;
                
                content.innerHTML = `
                    <h2 class="text-xl font-bold mb-6 text-gray-800">${q.t}</h2>
                    <div class="space-y-3">
                        ${q.opts.map((opt, i) => `
                            <button onclick="handleAnswer(${i})" class="w-full text-left p-4 border border-gray-200 rounded-xl hover:bg-green-50 hover:border-farmacia-green transition-all text-gray-700 font-medium">
                                ${opt}
                            </button>
                        `).join('')}
                    </div>
                `;
            } else {
                // Resultados
                const passed = currentQuiz.score >= level.passing;
                document.getElementById('quiz-progress').innerText = 'Resultados';
                
                if (passed) {
                    if (window.confetti) window.confetti();
                    saveProgress(level.id);
                }

                content.innerHTML = `
                    <div class="text-center pt-8">
                        <div class="text-6xl mb-4">${passed ? 'ðŸŽ‰' : 'ðŸ“š'}</div>
                        <h2 class="text-2xl font-bold mb-2 text-gray-900">${passed ? 'Â¡Aprobado!' : 'Sigue Intentando'}</h2>
                        <p class="mb-8 text-gray-500">Obtuviste ${currentQuiz.score} de ${level.qs.length} puntos</p>
                        
                        <div class="space-y-3">
                            <button onclick="startLevel(${level.id})" class="w-full bg-farmacia-green text-white font-bold py-3 rounded-lg flex justify-center items-center gap-2">
                                <i class="ph-arrows-clockwise"></i> Reintentar
                            </button>
                            <button onclick="closeQuiz()" class="w-full text-gray-500 py-3 underline">Volver al Panel</button>
                        </div>
                    </div>
                `;
            }
        }

        window.handleAnswer = (idx) => {
            const level = LEVELS.find(l => l.id === currentQuiz.levelId);
            const q = level.qs[currentQuiz.qIndex];
            if (idx === q.c) currentQuiz.score++;
            currentQuiz.qIndex++;
            renderQuiz();
        };

        async function saveProgress(id) {
            if (!appState.completedLevels.includes(id)) {
                appState.completedLevels.push(id);
                if (id === appState.currentLevel) appState.currentLevel++;
                
                // Guardar local
                localStorage.setItem('auxiliar_pro_data', JSON.stringify(appState));
                renderDashboard();

                // Guardar nube
                if (appState.uid) {
                    try {
                        await setDoc(doc(db, 'artifacts', appId, 'users', appState.uid, 'data', 'progress'), {
                            currentLevel: appState.currentLevel,
                            completedLevels: appState.completedLevels,
                            lastUpdate: new Date()
                        }, { merge: true });
                    } catch (e) {
                        console.warn("Fallo guardado nube", e);
                        document.getElementById('offline-badge').classList.remove('hidden');
                    }
                }
            }
        }

        // --- RENDERIZADORES ---

        function renderDashboard() {
            // Progreso
            const percent = Math.round((appState.completedLevels.length / LEVELS.length) * 100);
            document.getElementById('progress-percent').innerText = `${percent}%`;
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('user-welcome').innerText = `Hola, ${appState.name.split(' ')[0]}`;

            // Niveles
            const container = document.getElementById('levels-container');
            container.innerHTML = LEVELS.map(l => {
                const isLocked = l.id > appState.currentLevel;
                const isCompleted = appState.completedLevels.includes(l.id);
                const bgClass = isLocked ? 'bg-gray-50 opacity-60' : 'bg-white hover:shadow-md cursor-pointer hover:border-farmacia-green';
                const borderClass = isCompleted ? 'border-green-200 bg-green-50/30' : 'border-gray-200';
                const icon = isCompleted ? '<i class="ph-check-circle text-2xl text-white"></i>' : (isLocked ? '<i class="ph-lock text-xl text-gray-400"></i>' : `<span class="text-lg font-bold text-white">${l.id}</span>`);
                const iconBg = isCompleted ? 'bg-farmacia-green' : (isLocked ? 'bg-gray-200' : 'bg-farmacia-dark');

                return `
                    <div onclick="${!isLocked ? `startLevel(${l.id})` : ''}" class="relative p-5 rounded-xl border transition-all flex items-center gap-4 ${bgClass} ${borderClass}">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center shrink-0 ${iconBg}">
                            ${icon}
                        </div>
                        <div class="flex-1">
                            <h3 class="font-bold text-gray-800">${l.title}</h3>
                            <p class="text-xs text-gray-500">${l.desc}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderBlog() {
            document.getElementById('blog-container').innerHTML = POSTS.map(p => `
                <div class="border border-gray-200 p-4 rounded-xl mb-4 hover:border-farmacia-green transition-colors cursor-pointer">
                    <h3 class="font-bold text-gray-800">${p.t}</h3>
                    <p class="text-sm text-gray-500 mt-1">${p.e}</p>
                </div>
            `).join('');
        }

        // --- INIT ---
        
        // Listener Auth
        onAuthStateChanged(auth, (user) => {
            document.getElementById('loading-overlay').classList.add('hidden');
            if (user) {
                // Usuario Cloud
                appState.uid = user.uid;
                appState.isAuthenticated = true;
                
                // Cargar datos
                const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'progress');
                onSnapshot(userRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        appState.name = data.name || user.displayName || 'Estudiante';
                        appState.currentLevel = data.currentLevel || 1;
                        appState.completedLevels = data.completedLevels || [];
                        renderDashboard();
                    } else {
                        appState.name = user.displayName || 'Estudiante';
                        renderDashboard();
                    }
                }, (err) => {
                    console.warn("Offline", err);
                    document.getElementById('offline-badge').classList.remove('hidden');
                });
                
            } else {
                // Usuario Local (Fallback)
                const local = localStorage.getItem('auxiliar_pro_data');
                if (local) {
                    const data = JSON.parse(local);
                    if (data.isAuthenticated) {
                        appState = data;
                        document.getElementById('offline-badge').classList.remove('hidden');
                        renderDashboard();
                    }
                }
            }
        });

        // Init Blog
        renderBlog();

    </script>
</body>
</html>
