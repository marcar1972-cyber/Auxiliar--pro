import React, { useState, useEffect } from 'react';
import { initializeApp } from "firebase/app";
import { 
  getAuth, 
  signInWithEmailAndPassword, 
  createUserWithEmailAndPassword, 
  signOut, 
  onAuthStateChanged, 
  updateProfile,
  signInWithCustomToken
} from "firebase/auth";
import { 
  getFirestore, 
  doc, 
  setDoc, 
  onSnapshot 
} from "firebase/firestore";
import { 
  BookOpen, 
  ChevronRight, 
  User, 
  LogOut, 
  Lock, 
  CheckCircle, 
  Trophy, 
  ArrowLeft, 
  FileText, 
  Shield, 
  MessageCircle, 
  X, 
  RefreshCcw, 
  Eye, 
  AlertCircle, 
  Mail, 
  Key, 
  WifiOff
} from 'lucide-react';

// --- CONFIGURACI√ìN FIREBASE ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- DEFINICIONES ---

export type ViewState = 'LANDING' | 'DASHBOARD' | 'BLOG' | 'ARTICLE';

export interface UserState {
  uid: string;
  name: string;
  email: string;
  currentLevel: number;
  completedLevels: number[];
  isAuthenticated: boolean;
  isOfflineMode?: boolean;
}

export interface QuizState {
  isActive: boolean;
  levelId: number | null;
  currentQuestionIndex: number;
  score: number;
  showResult: boolean;
  answers: number[];
}

const APP_VERSION = "2.7.0"; // Versi√≥n flujo manual estricto

const BLOG_POSTS = [
  { id: 'art1', date: '15 NOV', title: 'Gu√≠a de Medicamentos Bioequivalentes', excerpt: 'Diferencia entre gen√©ricos, bioequivalentes y originales.', content: '<p>Los medicamentos bioequivalentes son aquellos que han demostrado cient√≠ficamente tener la misma eficacia y seguridad que el medicamento original...</p>' },
  { id: 'art2', date: '20 NOV', title: 'Almacenamiento y Cadena de Fr√≠o', excerpt: 'Protocolos para insulinas y vacunas.', content: '<p>La cadena de fr√≠o es fundamental para mantener la estabilidad de ciertos f√°rmacos termol√°biles...</p>' },
  { id: 'art3', date: '01 DIC', title: 'Legislaci√≥n: DS 466 Explicado', excerpt: 'Reglamento de farmacias para el examen.', content: '<p>El Decreto Supremo 466 aprueba el reglamento de farmacias, droguer√≠as, almacenes farmac√©uticos, botiquines y dep√≥sitos autorizados...</p>' }
];

const LEVELS = [
  {
    id: 1,
    title: 'Nivel 1: Farmacolog√≠a B√°sica',
    description: 'Conceptos fundamentales y v√≠as de administraci√≥n.',
    passingScore: 2,
    questions: [
      { id: 101, text: '¬øV√≠a de administraci√≥n que evita el paso hep√°tico?', options: ['V√≠a Oral', 'V√≠a Sublingual', 'V√≠a Rectal', 'V√≠a T√≥pica'], correctIndex: 1, explanation: 'La v√≠a sublingual pasa directo a circulaci√≥n sist√©mica.' },
      { id: 102, text: '¬øQu√© significa OTC?', options: ['Receta Retenida', 'Venta Directa', 'Antibi√≥tico', 'Psicotr√≥pico'], correctIndex: 1, explanation: 'Over The Counter: Venta directa.' },
      { id: 103, text: '¬øForma farmac√©utica s√≥lida?', options: ['Jarabe', 'Comprimido', 'Emulsi√≥n', 'Colirio'], correctIndex: 1, explanation: 'El comprimido es s√≥lido.' }
    ]
  },
  {
    id: 2,
    title: 'Nivel 2: Legislaci√≥n Sanitaria',
    description: 'C√≥digo Sanitario y reglamentos.',
    passingScore: 2,
    questions: [
      { id: 201, text: '¬øReceta para estupefacientes?', options: ['Simple', 'Retenida', 'Cheque', 'Magistral'], correctIndex: 2, explanation: 'Receta Cheque es obligatoria.' },
      { id: 202, text: '¬øResponsable t√©cnico de farmacia?', options: ['Due√±o', 'Auxiliar', 'Qu√≠mico Farmac√©utico', 'Gerente'], correctIndex: 2, explanation: 'El QF es el director t√©cnico.' }
    ]
  },
  {
    id: 3,
    title: 'Nivel 3: Atenci√≥n y Dispensaci√≥n',
    description: 'Buenas pr√°cticas e informaci√≥n al paciente.',
    passingScore: 1,
    questions: [
      { id: 301, text: '¬øQu√© verificar al dispensar antibi√≥ticos?', options: ['Precio', 'Receta y Vencimiento', 'Marca', 'Caja'], correctIndex: 1, explanation: 'La receta es obligatoria por ley.' }
    ]
  }
];

const triggerConfetti = () => {
  if (window.confetti) window.confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
};

const LOCAL_STORAGE_KEY = 'auxiliar_pro_data';
const getLocalData = () => { try { return JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || 'null'); } catch(e) { return null; } };
const saveLocalData = (data: any) => { try { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data)); } catch(e) {} };

// --- Componentes UI ---

const Button: React.FC<{ onClick?: () => void; children: React.ReactNode; variant?: 'primary' | 'secondary' | 'outline' | 'ghost'; className?: string; disabled?: boolean; fullWidth?: boolean; type?: 'button' | 'submit'; }> = ({ onClick, children, variant = 'primary', className = '', disabled = false, fullWidth = false, type = 'button' }) => {
  const baseStyles = "flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed";
  const variants = {
    primary: "bg-slate-900 text-white hover:bg-slate-800 shadow-lg",
    secondary: "bg-emerald-600 text-white hover:bg-emerald-700 shadow-md",
    outline: "bg-white border-2 border-gray-200 text-gray-700 hover:border-emerald-600 hover:text-emerald-600",
    ghost: "bg-transparent text-gray-500 hover:text-emerald-600 hover:bg-emerald-50",
  };
  return <button type={type} onClick={onClick} disabled={disabled} className={`${baseStyles} ${variants[variant]} ${fullWidth ? 'w-full' : ''} ${className}`}>{children}</button>;
};

// --- APP PRINCIPAL ---

export default function App() {
  const [view, setView] = useState<ViewState>('LANDING');
  const [user, setUser] = useState<UserState>({ uid: '', name: '', email: '', currentLevel: 1, completedLevels: [], isAuthenticated: false, isOfflineMode: false });
  const [quizState, setQuizState] = useState<QuizState>({ isActive: false, levelId: null, currentQuestionIndex: 0, score: 0, showResult: false, answers: [] });
  const [selectedArticleId, setSelectedArticleId] = useState<string | null>(null);
  
  // Estados para Modales
  const [showAuthModal, setShowAuthModal] = useState(false);
  const [authMode, setAuthMode] = useState<'login' | 'register'>('login');
  const [showLegalModal, setShowLegalModal] = useState(false);
  const [showForumModal, setShowForumModal] = useState(false);
  
  const [reviewMode, setReviewMode] = useState(false);
  const [loading, setLoading] = useState(true);

  // AUTH LISTENER
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        try { await signInWithCustomToken(auth, __initial_auth_token); } catch (e) {}
      }
    };
    initAuth();

    const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
      if (currentUser) {
        const userRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'data', 'progress');
        const unsubDoc = onSnapshot(userRef, (docSnap) => {
          if (docSnap.exists()) {
            const data = docSnap.data();
            setUser({
              uid: currentUser.uid, name: currentUser.displayName || data.name || 'Estudiante', email: currentUser.email || '',
              currentLevel: data.currentLevel || 1, completedLevels: data.completedLevels || [],
              isAuthenticated: true, isOfflineMode: false
            });
          } else {
            setUser({
              uid: currentUser.uid, name: currentUser.displayName || 'Estudiante', email: currentUser.email || '',
              currentLevel: 1, completedLevels: [],
              isAuthenticated: true, isOfflineMode: false
            });
          }
          setLoading(false);
        }, (error) => {
          console.warn("Modo Offline (Permisos):", error.message);
          fallbackToLocal(currentUser);
        });
        return () => unsubDoc();
      } else {
        const local = getLocalData();
        if (local && local.isAuthenticated) setUser(local);
        else setUser(prev => ({ ...prev, isAuthenticated: false }));
        setLoading(false);
      }
    });
    return () => unsubscribe();
  }, []);

  const fallbackToLocal = (currentUser: any) => {
    const local = getLocalData();
    const userData = {
        uid: currentUser.uid, name: currentUser.displayName || 'Estudiante', email: currentUser.email || '',
        isAuthenticated: true, isOfflineMode: true,
        currentLevel: local?.currentLevel || 1, completedLevels: local?.completedLevels || []
    };
    setUser(userData);
    saveLocalData(userData);
    setLoading(false);
  };

  const handleLogout = async () => {
    await signOut(auth);
    localStorage.removeItem(LOCAL_STORAGE_KEY);
    setUser({ uid: '', name: '', email: '', currentLevel: 1, completedLevels: [], isAuthenticated: false });
    setView('LANDING');
  };

  const startLevel = (levelId: number) => {
    setQuizState({ isActive: true, levelId, currentQuestionIndex: 0, score: 0, showResult: false, answers: [] });
    setReviewMode(false);
  };

  const handleAnswer = (idx: number) => {
    const level = LEVELS.find(l => l.id === quizState.levelId);
    if (!level) return;
    const isCorrect = idx === level.questions[quizState.currentQuestionIndex].correctIndex;
    const newAnswers = [...quizState.answers, idx];
    const newScore = isCorrect ? quizState.score + 1 : quizState.score;

    if (quizState.currentQuestionIndex + 1 < level.questions.length) {
      setQuizState(prev => ({ ...prev, answers: newAnswers, score: newScore, currentQuestionIndex: prev.currentQuestionIndex + 1 }));
    } else {
      setQuizState(prev => ({ ...prev, answers: newAnswers, score: newScore, showResult: true }));
      if (newScore >= level.passingScore) {
        triggerConfetti();
        saveProgress(level.id);
      }
    }
  };

  const saveProgress = async (completedId: number) => {
    const newCompleted = user.completedLevels.includes(completedId) ? user.completedLevels : [...user.completedLevels, completedId];
    const newCurrent = completedId + 1 > user.currentLevel ? completedId + 1 : user.currentLevel;
    const newData = { ...user, currentLevel: newCurrent, completedLevels: newCompleted };
    setUser(newData);

    if (user.isOfflineMode) {
      saveLocalData(newData);
    } else {
      try {
        await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'progress'), {
          currentLevel: newCurrent, completedLevels: newCompleted, lastUpdate: new Date()
        }, { merge: true });
      } catch (e) {
        saveLocalData({ ...newData, isOfflineMode: true });
        setUser(prev => ({ ...prev, isOfflineMode: true }));
      }
    }
  };

  // --- Handlers UI ---
  // CORRECCI√ìN: openRegister ahora asegura que se cierre sesi√≥n si hab√≠a una previa para evitar el paso directo
  const openLogin = () => { setAuthMode('login'); setShowAuthModal(true); };
  const openRegister = async () => { 
    setAuthMode('register'); 
    setShowAuthModal(true);
  };

  // --- COMPONENTES VISUALES ---

  const AuthModal = () => {
    const [isRegistering, setIsRegistering] = useState(authMode === 'register');
    const [formData, setFormData] = useState({ name: '', email: '', password: '' });
    const [error, setError] = useState('');
    const [loadingAuth, setLoadingAuth] = useState(false);

    useEffect(() => setIsRegistering(authMode === 'register'), [authMode]);

    const handleSubmit = async (e: React.FormEvent) => {
      e.preventDefault();
      setError('');
      setLoadingAuth(true);

      try {
        if (isRegistering) {
          // REGISTRO
          const userCred = await createUserWithEmailAndPassword(auth, formData.email, formData.password);
          await updateProfile(userCred.user, { displayName: formData.name });
          
          await setDoc(doc(db, 'artifacts', appId, 'users', userCred.user.uid, 'data', 'progress'), {
            name: formData.name, currentLevel: 1, completedLevels: [], createdAt: new Date()
          });
          
          setShowAuthModal(false);
          setView('DASHBOARD');
        } else {
          // LOGIN
          await signInWithEmailAndPassword(auth, formData.email, formData.password);
          setShowAuthModal(false);
          setView('DASHBOARD');
        }
      } catch (err: any) {
        console.error(err);
        if (err.code === 'auth/email-already-in-use') setError('El correo ya est√° registrado.');
        else if (err.code === 'auth/wrong-password') setError('Contrase√±a incorrecta.');
        else if (err.code === 'auth/user-not-found') setError('Usuario no encontrado.');
        else if (err.code === 'auth/weak-password') setError('La contrase√±a es muy d√©bil (min 6 caracteres).');
        else setError('Error de conexi√≥n o datos incorrectos.');
      } finally {
        setLoadingAuth(false);
      }
    };

    if (!showAuthModal) return null;

    return (
      <div className="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl w-full max-w-sm shadow-2xl p-6 relative animate-in zoom-in-95 duration-200">
          <button onClick={() => setShowAuthModal(false)} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><X size={20} /></button>
          
          <div className="text-center mb-6">
            <div className="bg-emerald-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 text-emerald-600">
              <User size={24} />
            </div>
            <h2 className="text-2xl font-bold text-gray-900">{isRegistering ? 'Crear Cuenta' : 'Iniciar Sesi√≥n'}</h2>
            <p className="text-sm text-gray-500 mt-1">{isRegistering ? 'Reg√≠strate para guardar tu progreso' : 'Ingresa con tu correo y contrase√±a'}</p>
          </div>

          <form onSubmit={handleSubmit} className="space-y-4">
            {isRegistering && (
              <div className="relative">
                <User size={18} className="absolute left-3 top-3.5 text-gray-400" />
                <input type="text" placeholder="Tu Nombre" required value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full pl-10 p-3 rounded-lg border border-gray-300 focus:border-emerald-600 outline-none" />
              </div>
            )}
            <div className="relative">
              <Mail size={18} className="absolute left-3 top-3.5 text-gray-400" />
              <input type="email" placeholder="Correo Electr√≥nico" required value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} className="w-full pl-10 p-3 rounded-lg border border-gray-300 focus:border-emerald-600 outline-none" />
            </div>
            <div className="relative">
              <Key size={18} className="absolute left-3 top-3.5 text-gray-400" />
              <input type="password" placeholder="Contrase√±a" required value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} className="w-full pl-10 p-3 rounded-lg border border-gray-300 focus:border-emerald-600 outline-none" />
            </div>

            {error && <div className="p-3 bg-red-50 text-red-600 text-xs rounded-lg flex items-center gap-2"><AlertCircle size={14} /> {error}</div>}

            <Button type="submit" fullWidth variant="primary" disabled={loadingAuth}>
              {loadingAuth ? 'Procesando...' : (isRegistering ? 'Registrarse' : 'Entrar')}
            </Button>

            <div className="text-center mt-4">
              <button type="button" onClick={() => { setIsRegistering(!isRegistering); setError(''); }} className="text-sm text-emerald-600 font-medium hover:underline">
                {isRegistering ? '¬øYa tienes cuenta? Inicia Sesi√≥n' : '¬øNo tienes cuenta? Reg√≠strate'}
              </button>
            </div>
          </form>
        </div>
      </div>
    );
  };

  const LandingPage = () => (
    <div className="flex-1 flex flex-col relative animate-fade-in overflow-y-auto">
      <header className="w-full py-4 px-6 flex justify-between items-center border-b border-gray-100 bg-white/95 sticky top-0 z-10 backdrop-blur-md">
        <div className="flex items-center gap-2">
          <div className="bg-emerald-600 text-white p-1.5 rounded-md"><Shield size={20} strokeWidth={3} /></div>
          <span className="font-heading font-bold text-xl text-gray-900">Auxiliar<span className="text-emerald-600">Pro</span></span>
        </div>
        <Button variant="ghost" onClick={openLogin} className="!px-3 !py-1 text-xs">
          Entrar
        </Button>
      </header>

      <main className="flex-1 flex flex-col items-center text-center px-6 mt-10 pb-10">
        <div className="inline-flex items-center gap-2 bg-emerald-100 border border-emerald-200 text-emerald-800 text-xs font-bold px-3 py-1 rounded-full mb-6 uppercase tracking-wide">
          <span className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> Preparaci√≥n 2026
        </div>
        <h1 className="font-heading text-4xl font-extrabold text-gray-900 leading-tight mb-4">Prep√°rate para tu examen de <br /><span className="text-emerald-600">Auxiliar de Farmacia</span></h1>
        <p className="text-gray-500 text-lg mb-8 leading-relaxed max-w-xs mx-auto">Plataforma de estudio independiente. Reg√≠strate para guardar tu progreso.</p>

        <div className="w-full space-y-4 mb-12 max-w-sm mx-auto">
          {/* CORRECCI√ìN: Bot√≥n siempre dice Comenzar Ahora y siempre abre el Registro */}
          <Button fullWidth onClick={openRegister}>
            Comenzar Ahora <ChevronRight size={20} className="inline ml-1"/>
          </Button>
          <Button fullWidth variant="outline" onClick={() => setView('BLOG')}><BookOpen size={18} /> Leer Gu√≠as y Art√≠culos</Button>
        </div>

        <footer className="text-center border-t border-gray-200 pt-8 pb-4 w-full mt-auto">
          <p className="text-xs text-gray-400 mb-4">¬© 2025 AuxiliarPro. v{APP_VERSION}</p>
          <div className="flex justify-center gap-4 text-[10px] text-gray-500 uppercase font-semibold"><button onClick={() => setShowLegalModal(true)} className="hover:text-emerald-600">T√©rminos</button><button onClick={() => setShowLegalModal(true)} className="hover:text-emerald-600">Privacidad</button></div>
        </footer>
      </main>
    </div>
  );

  const Dashboard = () => {
    const progress = (user.completedLevels.length / LEVELS.length) * 100;
    return (
      <div className="flex-1 flex flex-col bg-slate-50 h-full animate-fade-in relative">
        <header className="bg-white shadow-sm py-4 px-6 flex justify-between items-center sticky top-0 z-10">
          <div>
            <span className="font-heading font-bold text-gray-700 block">Panel de Estudio</span>
            <div className="flex items-center gap-2"><span className="text-xs text-gray-400">Hola, {user.name.split(' ')[0]}</span>{user.isOfflineMode && <span className="flex items-center text-[10px] text-amber-600 bg-amber-50 px-1.5 py-0.5 rounded border border-amber-200"><WifiOff size={10} className="mr-1" /> Offline</span>}</div>
          </div>
          <button onClick={handleLogout} className="text-gray-400 hover:text-red-500 transition-colors"><LogOut size={20} /></button>
        </header>
        <main className="flex-1 p-6 w-full pb-20 overflow-y-auto custom-scrollbar">
          <div className="bg-white rounded-2xl p-6 shadow-md border-t-4 border-emerald-600 mb-8">
            <div className="flex justify-between items-end mb-2"><span className="text-gray-500 text-xs font-bold uppercase tracking-wider">Tu Progreso</span><span className="text-emerald-600 font-bold text-xl">{Math.round(progress)}%</span></div>
            <div className="w-full bg-gray-100 rounded-full h-2.5"><div className="bg-emerald-600 h-2.5 rounded-full transition-all duration-1000 ease-out" style={{ width: `${progress}%` }}></div></div>
          </div>
          <div className="space-y-4">
            {LEVELS.map((level) => {
              const isLocked = level.id > user.currentLevel;
              const isCompleted = user.completedLevels.includes(level.id);
              return (
                <div key={level.id} onClick={() => !isLocked && startLevel(level.id)} className={`relative p-5 rounded-xl border transition-all ${isLocked ? 'bg-gray-50 opacity-60 cursor-not-allowed' : 'bg-white shadow-sm cursor-pointer hover:shadow-md hover:border-emerald-300'} ${isCompleted ? 'border-green-200 bg-green-50/30' : ''}`}>
                  <div className="flex items-center gap-4">
                    <div className={`w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg text-white ${isCompleted ? 'bg-green-500' : isLocked ? 'bg-gray-300' : 'bg-slate-900'}`}>{isCompleted ? <CheckCircle size={24} /> : isLocked ? <Lock size={20} /> : level.id}</div>
                    <div className="flex-1"><h3 className="font-bold text-gray-800">{level.title}</h3><p className="text-xs text-gray-500">{level.description}</p></div>
                  </div>
                </div>
              );
            })}
          </div>
        </main>
      </div>
    );
  };

  if (loading) return <div className="h-screen w-full flex items-center justify-center bg-white"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600"></div></div>;

  return (
    <div className="w-full max-w-md bg-white h-screen md:h-[90vh] md:rounded-3xl md:shadow-2xl overflow-hidden flex flex-col relative font-sans mx-auto border border-gray-100">
      {view === 'LANDING' && <LandingPage />}
      {view === 'DASHBOARD' && <Dashboard />}
      {/* Blog & Article views simplified for brevity but functional */}
      {view === 'BLOG' && (
        <div className="flex-1 flex flex-col bg-white h-full animate-slide-up">
          <header className="bg-white shadow-sm py-4 px-6 flex items-center gap-3"><button onClick={() => setView('LANDING')}><ArrowLeft size={24} /></button><span className="font-bold text-lg">Recursos</span></header>
          <main className="flex-1 p-6 overflow-y-auto">{BLOG_POSTS.map(post => <div key={post.id} onClick={() => {setSelectedArticleId(post.id); setView('ARTICLE');}} className="border p-4 rounded-xl mb-4 cursor-pointer hover:border-emerald-600"><h3 className="font-bold">{post.title}</h3><p className="text-sm text-gray-500">{post.excerpt}</p></div>)}</main>
        </div>
      )}
      {view === 'ARTICLE' && selectedArticleId && (
        <div className="flex-1 flex flex-col bg-white h-full animate-fade-in">
          <header className="bg-white shadow-sm py-4 px-6 flex items-center gap-3"><button onClick={() => setView('BLOG')}><ArrowLeft size={24} /></button><span className="font-bold text-lg">Art√≠culo</span></header>
          <main className="flex-1 p-6 overflow-y-auto"><h1 className="text-2xl font-bold mb-4">{BLOG_POSTS.find(p=>p.id===selectedArticleId)?.title}</h1><div dangerouslySetInnerHTML={{__html: BLOG_POSTS.find(p=>p.id===selectedArticleId)?.content || ''}} /></main>
        </div>
      )}

      {/* Quiz Modal */}
      {quizState.isActive && (
        <div className="absolute inset-0 z-50 bg-white flex flex-col animate-slide-up">
          <div className="bg-slate-900 p-6 text-white flex justify-between items-center"><h3>Pregunta {quizState.currentQuestionIndex + 1}</h3><button onClick={() => setQuizState(prev => ({...prev, isActive: false}))}><X size={24}/></button></div>
          <div className="flex-1 p-6 overflow-y-auto">
            {!quizState.showResult ? (
              <>
                <h2 className="text-xl font-bold mb-6">{LEVELS.find(l=>l.id===quizState.levelId)?.questions[quizState.currentQuestionIndex].text}</h2>
                <div className="space-y-3">{LEVELS.find(l=>l.id===quizState.levelId)?.questions[quizState.currentQuestionIndex].options.map((opt, i) => <button key={i} onClick={() => handleAnswer(i)} className="w-full text-left p-4 border rounded-xl hover:bg-emerald-50 hover:border-emerald-600 transition-all">{opt}</button>)}</div>
              </>
            ) : (
              <div className="text-center pt-10">
                <div className="text-6xl mb-4">{quizState.score >= (LEVELS.find(l=>l.id===quizState.levelId)?.passingScore || 0) ? 'üéâ' : 'üìö'}</div>
                <h2 className="text-2xl font-bold mb-2">{quizState.score >= (LEVELS.find(l=>l.id===quizState.levelId)?.passingScore || 0) ? '¬°Aprobado!' : 'Sigue Intentando'}</h2>
                <p className="mb-8">Puntaje: {quizState.score}</p>
                <div className="space-y-3">
                  {!reviewMode && <Button fullWidth variant="outline" onClick={() => setReviewMode(true)}><Eye size={18}/> Ver Respuestas</Button>}
                  <Button fullWidth onClick={() => startLevel(quizState.levelId!)}><RefreshCcw size={18}/> Reintentar</Button>
                  <button onClick={() => setQuizState(prev => ({...prev, isActive: false}))} className="text-sm text-gray-500 underline mt-4">Volver</button>
                </div>
                {reviewMode && <div className="mt-8 text-left space-y-4">{LEVELS.find(l=>l.id===quizState.levelId)?.questions.map((q, i) => <div key={i} className="bg-gray-50 p-3 rounded border"><p className="font-bold text-sm">{q.text}</p><p className={`text-sm ${quizState.answers[i]===q.correctIndex ? 'text-green-600' : 'text-red-500'}`}>Tu respuesta: {q.options[quizState.answers[i]]}</p>{quizState.answers[i]!==q.correctIndex && <p className="text-sm text-green-600">Correcta: {q.options[q.correctIndex]}</p>}</div>)}</div>}
              </div>
            )}
          </div>
        </div>
      )}

      <AuthModal />
      {/* Modales simples de texto */}
      {showLegalModal && <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4"><div className="bg-white p-6 rounded-xl max-w-sm"><h3 className="font-bold mb-2">Legal</h3><p className="text-sm text-gray-600 mb-4">Esta es una aplicaci√≥n de demostraci√≥n educativa.</p><Button onClick={() => setShowLegalModal(false)}>Cerrar</Button></div></div>}
      {showForumModal && <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4"><div className="bg-white p-6 rounded-xl max-w-sm text-center"><h3 className="font-bold mb-4">Comunidad</h3><Button fullWidth className="bg-green-600 mb-2"><MessageCircle size={18}/> WhatsApp</Button><Button fullWidth className="bg-blue-600" onClick={() => setShowForumModal(false)}>Facebook</Button><button onClick={() => setShowForumModal(false)} className="block mt-4 text-sm text-gray-400 mx-auto">Cerrar</button></div></div>}
    </div>
  );
}
